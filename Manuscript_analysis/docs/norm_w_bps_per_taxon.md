# Norm_w_bps_per_taxon.py

Internal script
Run:

```
python3 uscripts/norm_w_bps_per_taxon.py
```

### : Description :

It calculates the number of AMP genes per taxon per assembled base pair.
Taking the total assembled base pairs per taxon, we normalize the total number of
AMP genes from that taxon. The error was calculated using the formula:

`np.sqrt(p*(1-p)/n)`

### : Inputs :

1. **data/taxonomy_annotation.tsv.gz:**

Table from AMPSphere v2022-03 version. It consists in a table generated by filtering
the taxonomy assigned to contigs and AMP candidates. The AMP candidates assigned to
genus or species levels were considerd. This table has the info related to the
lowest taxonomic level each AMP had in AMPSphere. Its columns are:
    
    amp - accession in AMPSphere v2022-03 resource
    taxid - accession in NCBI taxID database
    level - lowest taxonomy classification (Unknown, Root, Kingdom, Phylum,
            Class, Order, Family, Genus, Species)
    source - taxon assigned to the contig from which the AMP was predicted
    fixed - one term designating taxonomy, here stands for genus

2. **data/prevotella_species_list.tsv.gz:**

Table generated manually after curation of species belonging to *Prevotella* genus.
Data obtained from [lpsn.dsmz.de](https://lpsn.dsmz.de). Its columns are:

    Species name - *Prevotella* species
    Host(s) - host from which the isolate was obtained, e.g. human
    Host site(s) - site from which the isolate was obtained, e.g. guts
    Strain - name of the isolate, strain code

3. **data/complete_amps_associated_taxonomy.tsv.gz:**

Table obtained during metadata processing. It contains detailed information about 
AMP genes, such as their start/end codons, GC contents, GTDB annotation of their 
contigs using MMSeqs2, and etc. Its columns are:

    amp - accession in AMPSphere v2022-03 resource
    gmsc - accession in the GMSC10 resource
    sample - biosample code
    contig - contig name
    start - gene start position in the contig
    stop - gene stop position in the contig
    strand - +1 or -1 for direct or reverse complement, respectively
    fid - random unique code for the gene in the contig
    partial - ends classification (complete genes - 00)
    start_type - start codon
    rbs_motif - ribosome binding motif
    rbs_spacer - ribosome binding motif spacer
    gc_cont - content of GC in percent
    taxid - NCBI taxID
    level - taxonomy level (Root, Kingdom, ..., genus, species)
    source - microbial source name
    retained - float
    assigned - float
    agreement - float
    support - probability, support measure, float
    specI - species cluster from ProGenomes2
    
3. **data/bps-per-taxon.tsv.xz:**

Table containing the number of assembled base pairs per taxon
in the AMPSphere pre-analysis. Its columns are:

    taxid - NCBI taxID
    level - taxonomy level (Root, Kingdom, ..., genus, species)
    name - microbial taxon 
    nbps - number of assembled base pairs

4. **data/bac120_GTDB.tsv.xz**

Table with the taxonomy lineages from GTDB.
It was obtained from the online resource, excluding
the first column relative to the genomes, substituting
the separatos to be tab and cleaning the duplicates.
Its columns are:

    domain
    phylum
    class
    order
    family
    genus
    species

### : Outputs :

1. **amps_per_assembled_Gbp_per_taxon.tsv.xz**

Table containing the following columns:

    fixed - taxon
    amp_genes - number of amp genes identified in a taxon
    nbps - assembled base pair per a given taxon
    amps_per_Gbp - amp genes per assembled gigabase pairs

2. **normalized_amps_per_bp_per_taxon.tsv.xz**

Table containing the following columns:

    fixed - taxon
    amp_genes - number of amp genes identified in a taxon
    nbps - assembled base pair per a given taxon
    amps_per_Gbp - amp genes per assembled gigabase pairs
    MOE - margin of error
    UL - upper limit (x+MOE)
    LL - lower limit (x-MOE)
    VAR_pct - percent variation using MOE 


3. **screen_for_moe_pct.tsv.xz**

Table generated by screening the percent margin of error (MOE) of AMPs per assembled
gigbase pairs per taxon. It contains the follwoing columns:
    
    cutoff - maximum percent margin of error
    dflen - number of taxa after applying the cutoff
    top10_avg - the top 10 taxa with highest AMPs per assembled gigabase pairs
    top10_UL - the top 10 taxa with highest AMPs per assembled gigabase pairs corrected as upper limit using MOE
    top10_LL - the top 10 taxa with highest AMPs per assembled gigabase pairs corrected as lower limit using MOE
    c_avg_UL - percent conservation of taxa in the top 10 positions between the inferred density and upper limit 
    c_avg_LL - percent conservation of taxa in the top 10 positions between the inferred density and lower limit
    c_UL_LL - percent conservation of taxa in the top 10 positions between the upper and lower limit


4. **prevotella_species.tsv.gz**

Specific AMP density for *Prevotella* species. It contains the following
columns:

    fixed - *Prevotella* species
    amps - number of AMP genes
    index - integer
    taxid - NCBI taxID
    level - genus/species
    name - species/strain
    nbps - assembled base pairs
    amps_per_assembled_Gbp - AMP genes per assembled gigabase pairs

5. **amps_per_Gbp_per_genus.{svg/png}**

Scatter plot showing the correlation between the number of AMP genes and the
total assembled base pairs per genus. The `x axis` is the assembled base pairs
per genus, and `y axis` is the AMP genes per genus.

6. **taxonomy_test_ampspergbp.tsv**

Table with the Mann-Whitney U test of AMPs per assembled gigabase pairs by genera in 
the phyla with 100 or more genera. MOE representing more than 100% of the calculated
value were eliminated. The columns are:

    tax1 - taxon 1
    tax2 - taxon 2
    u_stat - Mann-Whitney U test statistic
    p-value - Bonferroni corrected p-value

7. **taxonomy.png**

Box plot containing in the `x axis` the phyla with 100 genera or more, and in the
`y axis` is the AMPs per assembled gigabase pairs by genera. MOE representing more
than 100% of the calculated AMP density were eliminated.

